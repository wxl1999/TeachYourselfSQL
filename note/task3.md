## 存储过程

存储过程就是为以后使用而保存的一条 或多条 SQL语句。可将其视为批文件，虽然它们的作用不仅限于批处理。

### 为何要使用？

简单、安全、高性能

- 通过把处理封装在一个易用的单元中，可以简化复杂的操作
- 不要求反复建立一系列处理步骤，保证了数据的一致性
- 简化对变动的管理。如果表名、列名或业务逻辑（或别的内容）有变 化，那么只需要更改存储过程的代码。通过存储过程限制对基础数据的访问，减少了数据讹误
- 存储过程通常以编译过的形式存储，所以 DBMS处理命令所需的 工作量少，提高了性能

### 执行

EXECUTE 接受存储过程 名和需要传递给它的任何参数

```sql
EXECUTE AddNewProduct( 'JTS01',
						'Stuffed Eiffel Tower',                         					6.49,                        
						'Plush stuffed toy with the text La 
						➥Tour Eiffel in red white and blue' ); 
```

在 Products 表中还有另一个需要值的列 prod_id 列，它 是这个表的主键。为什么这个值不作为属性传递给存储过程？要保证恰 当地生成此 ID，最好是使生成此 ID 的过程自动化

对于具体的 DBMS，可能包括以下的 执行选择： 
- 参数可选，具有不提供参数时的默认值； 
- 不按次序给出参数，以“参数=值”的方式给出参数值。 
- 输出参数，允许存储过程在正执行的应用程序中更新所用的参数。 
- 用 SELECT 语句检索数据。 
- 返回代码，允许存储过程返回一个值到正在执行的应用程序。 

### 创建

由于书中未提及MySQL，这里先略过...

## 事务处理

利用事务处理，可以保证一组操作不会中途停止，它们要么完全执 行，要么完全不执行（除非明确指示）。如果没有错误发生，整组语句提 交给（写到）数据库表；如果发生错误，则进行回退（撤销），将数据库 恢复到某个已知且安全的状态。

术语： 

- 事务（transaction）指一组 SQL语句； 
- 回退（rollback）指撤销指定 SQL语句的过程； 
- 提交（commit）指将未存储的 SQL语句结果写入数据库表；
- 保留点（savepoint）指事务处理中设置的临时占位符（placeholder）， 可以对它发布回退（与回退整个事务处理不同）。

### 控制

管理事务的关键在于将 SQL语句组分解为逻辑块，并明确规定数据何时 应该回退，何时不应该回退。 

#### 标识事务处理块的开始

```START TRANSACTION```

#### 撤销

```sql
DELETE FROM Orders; 
ROLLBACK; 
```

#### 提交

一般的 SQL语句都是针对数据库表直接执行和编写的。这就是所谓的隐 式提交（implicit commit），即提交（写或保存）操作是自动进行的

在事务处理块中，提交不会隐式进行。进行明确的提交，使用 COMMIT 语句

SQL中一般使用```COMMIT TRANSACTION```或者```COMMIT```

#### 使用保留点

要支持回退部分事务，必须在事务处理块中的合适位置放置占位符。这 样，如果需要回退，可以回退到某个占位符。 

创建占位符，可使用 SAVEPOINT 语句

```SAVEPOINT delete1;```

每个保留点都要取能够标识它的唯一名字，以便在回退时，DBMS 知道 回退到何处。

```ROLLBACK TO delete1;```

## 使用游标

SQL检索操作返回一组称为结果集的行，这组返回的行都是与 SQL语句 相匹配的行（零行或多行）。

简单地使用 SELECT 语句，没有办法得到第 一行、下一行或前 10行。

有时，需要在检索出来的行中前进或后退一行或多行，这就是游标的用 途所在。

在存储了 游标之后，应用程序可以根据需要滚动或浏览其中的数据。 

游标主要用于交互式应用，其中用户需要滚动屏幕上的数据，并对数据 进行浏览或做出更改。

### 创建

- 示例

```mysql
DECLARE CustCursor CURSOR 
FOR 
SELECT * FROM Customers WHERE cust_email IS NULL;
```

### 打开

- 示例

```mysql
OPEN CURSOR CustCursor
```

可以用 FETCH 语句访问游标数据

### 关闭

- 示例

```CLOSE CustCursor```

## 高级SQL特性

### 主键

主键是一种特殊的约束，用来保证一列（或 一组列）中的值是唯一的，而且永不改动。

任意列作为主键的条件：

- 任意两行的主键值都不相同。 
- 每行都具有一个主键值（即列中不允许 NULL 值）。 
- 包含主键值的列从不修改或更新
- 主键值不能重用。如果从表中删除某一行，其主键值不分配给新行。 

示例：

```mysql
CREATE TABLE Vendors  
(     
vend_id         CHAR(10)       NOT NULL PRIMARY KEY,      vend_name       CHAR(50)       NOT NULL,     
vend_address    CHAR(50)       NULL,     
vend_city       CHAR(50)       NULL,     
vend_state      CHAR(5)        NULL,     
vend_zip        CHAR(10)       NULL,     
vend_country    CHAR(50)       NULL 
);

ALTER TABLE Vendors  
ADD CONSTRAINT PRIMARY KEY (vend_id); 
```

### 外键

外键是保证引用完整性的极其重要部分

示例：

```mysql
CREATE TABLE Orders 
(     
order_num     INTEGER     NOT NULL PRIMARY KEY,
order_date    DATETIME    NOT NULL,
cust_id       CHAR(10)    NOT NULL REFERENCES  
➥Customers(cust_id) 
);
```

其中的表定义使用了 REFERENCES 关键字，它表示 cust_id 中的任何值都必须是 Customers 表的 cust_id 中的值。 

除帮助保证引用完整性外，在定义外键后，DBMS 不允许删除在另一个表中具有关联行的行。

> 级联删除: 该特性在从一个表中删除行时删除所有相关的数据
> 

### 唯一约束

唯一约束用来保证一列（或一组列）中的数据是唯一的。

与主键的区别：

- 表可包含多个唯一约束，但每个表只允许一个主键。 
- 唯一约束列可包含 NULL 值。 
- 唯一约束列可修改或更新。 
- 唯一约束列的值可重复使用。 
- 与主键不一样，唯一约束不能用来定义外键。 

唯一约束既可以用 UNIQUE 关 键字在表定义中定义，也可以用单独的 CONSTRAINT 定义

### 检查约束

常见用途：

- 检查最小或最大值。例如，防止 0个物品的订单（即使0是合法的数）。
- 指定范围。例如，保证发货日期大于等于今天的日期，但不超过今天 起一年后的日期。- 
- 只允许特定的值。例如，在性别字段中只允许 M 或 F。

示例：

```mysql
CREATE TABLE OrderItems 
(     
order_num     INTEGER     NOT NULL,     
order_item    INTEGER     NOT NULL,     
prod_id       CHAR(10)    NOT NULL,     
quantity      INTEGER     NOT NULL CHECK (quantity > 0),     item_price    MONEY       NOT NULL 
);
```

检查名为 gender 的列只包含 M 或 F，可编写如下的 ALTER TABLE 语句：

```ADD CONSTRAINT CHECK (gender LIKE '[MF]') ```

> 有的 DBMS允许用户定义自己的数据类型。它们是定义检查约束（或 其他约束）的基本简单数据类型
> 
> 定制数据类型的优点是只需施加约束一次（在数据类型 定义中），而每当使用该数据类型时，都会自动应用这些约束

### 索引

索引用来排序数据以加快搜索和排序操作的速度

可以在一个或多个列上定义索引，使 DBMS保存 其内容的一个排过序的列表。在定义了索引后，DBMS 以使用书的索引 类似的方法使用它。DBMS 搜索排过序的索引，找出匹配的位置，然后 检索这些行。

- 索引改善检索操作的性能，但降低了数据插入、修改和删除的性能。 在执行这些操作时，DBMS必须动态地更新索引。 
- 索引数据可能要占用大量的存储空间。 
- 并非所有数据都适合做索引。取值不多的数据（如州）不如具有更多 可能值的数据（如姓或名），能通过索引得到那么多的好处。 
- 索引用于数据过滤和数据排序。如果你经常以某种特定的顺序排序数 据，则该数据可能适合做索引。 

示例：

```mysql
CREATE INDEX prod_name_ind 
ON Products (prod_name);
```

> 最好定期检查索引，并根据需要对索引进行调整。 
> 

### 触发器

触发器是特殊的存储过程，它在特定的数据库活动发生时自动执行。触发 器可以与特定表上的 INSERT、UPDATE 和DELETE 操作（或组合）相关联。

触发器内的代码具有以下数据的访问权：

- INSERT 操作中的所有新数据； 
- UPDATE 操作中的所有新数据和旧数据； 
- DELETE 操作中删除的数据。 

#### 常见用途

- 保证数据一致。例如，在 INSERT 或 UPDATE 操作中将所有州名转换 为大写。 
- 基于某个表的变动在其他表上执行活动。例如，每当更新或删除一行 时将审计跟踪记录写入某个日志表。 
- 进行额外的验证并根据需要回退数据。例如，保证某个顾客的可用资 金不超限定，如果已经超出，则阻塞插入。 
- 计算计算列的值或更新时间戳。 

一般来说，约束的处理比触发器快，因此在可能的时候，应该尽量使 用约束。

### 数据库安全

任何安全系统的基础都是用户授权和身份确认

一般说来，需要保护的操作有： 

- 对数据库管理功能（创建表、更改或删除已存在的表等）的访问； 
- 对特定数据库或表的访问； 
- 访问的类型（只读、对特定列的访问等）； 
- 仅通过视图或存储过程对表进行访问； 
- 创建多层次的安全措施，从而允许多种基于登录的访问和控制； 
- 限制管理用户账号的能力。 

安全性使用 SQL的 GRANT 和 REVOKE 语句来管理
















